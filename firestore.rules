rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isActiveApproved() {
      return signedIn()
        && myUserDoc().exists()
        && myUserDoc().data.approved == true
        && (myUserDoc().data.active == null || myUserDoc().data.active == true);
    }

    function roleIs(r) {
      return isActiveApproved() && myUserDoc().data.role == r;
    }

    function roleIn(roles) {
      return isActiveApproved() && (myUserDoc().data.role in roles);
    }

    // USERS
    match /users/{uid} {
      allow create: if signedIn()
        && request.auth.uid == uid
        // Users can only self-register as a regular user
        && request.resource.data.role == 'user'
        && request.resource.data.approved == false
        && (request.resource.data.active == true || request.resource.data.active == null);

      allow read: if signedIn() && (request.auth.uid == uid || roleIs('admin'));

      // Users may update ONLY their display fields (cannot change role/approved/active)
      allow update: if signedIn()
        && request.auth.uid == uid
        && request.resource.data.role == resource.data.role
        && request.resource.data.approved == resource.data.approved
        && request.resource.data.active == resource.data.active;

      // Admin can fully manage users
      allow update, delete: if roleIs('admin');
    }

    // STOCK ITEMS
    match /stockItems/{id} {
      allow read: if isActiveApproved();                 // all approved users can read stock
      allow create, update, delete: if roleIn(['admin','warehouse']);
    }

    // REQUESTS
    match /requests/{id} {
      // Create request by the authenticated user
      allow create: if isActiveApproved()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.status == 'Pending'
        && request.resource.data.qty is number
        && request.resource.data.qty > 0;

      // User can read only his requests; managers can read all
      allow read: if roleIn(['admin','warehouse','technical'])
        || (signedIn() && resource.data.createdBy == request.auth.uid);

      // Warehouse/Admin can update request (approve/reject/fulfill), user cannot update status
      allow update: if roleIn(['admin','warehouse']);

      allow delete: if roleIs('admin');
    }

    // STOCK MOVEMENTS
    match /stockMovements/{id} {
      allow read: if roleIn(['admin','warehouse','technical']);
      allow create: if roleIn(['admin','warehouse']);
      allow update, delete: if roleIs('admin');
    }
  }
}
